<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>IrealCAO / ICAO (City, CC_HINT) - Airport</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload" href="/navdb/_/leaflet/libre-franklin-v11-latin-100.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/libre-franklin-v11-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/libre-franklin-v11-latin-600.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/libre-franklin-v11-latin-100italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/libre-franklin-v11-latin-200italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/libre-franklin-v11-latin-italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/libre-franklin-v11-latin-600italic.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/SourceCodePro-ExtraLight.ttf.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/SourceCodePro-ExtraLightIt.ttf.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/SourceCodePro-Regular.ttf.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/SourceCodePro-It.ttf.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/SourceCodePro-Semibold.ttf.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/navdb/_/leaflet/SourceCodePro-SemiboldIt.ttf.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="/navdb/_/leaflet/leaflet.min.css">
    <link rel="stylesheet" href="/navdb/_/leaflet/custom.min.css">
    <script src="/navdb/_/leaflet/leaflet.min.js"></script>
</head>
<body>
<header>
    <p>HOME <a href="BASE_URL/PATH/" class="no-decor">NavDB</a>
            - ( <a href="BASE_URL/PATH/IrealCAO/" class="no-decor">IrealCAO</a>
            | <a href="BASE_URL/PATH/country/cc_page.html" class="no-decor">Cc_page</a> )
            / ( <a href="BASE_URL/PATH/ANCHOR/IC_PREFIX" class="no-decor">IC_PREFIX</a>
            / <a href="BASE_URL/PATH/ANCHOR/IC_PREFIX_ICAO" class="no-decor">ICAO</a> )
            (City, CC_HINT) - Airport</p>
</header>
<main>
    <section>
        <h1>(City, CC_HINT) - Airport</h1>
        <div id="map"></div>
        <h2>Satellite Imagery &amp; More</h2>
        <p>&nbsp;Airport: <a
                href="URL"
                class="no-decor" target="_blank">ICAO</a>
            - (<a href="index.json" class="no-decor" target="_blank">GeoJSON data</a> |
               <a href="index.r.txt" class="no-decor" target="_blank">R source</a>)
        </p>
        <table>
            <tr>
                <th>Area Code</th><th>Prefix</th><th>ICAO</th><th class="ra">Latitude</th><th class="ra">Longitude</th><th class="ra">Elevation</th>
                <th class="la">Updated</th><th class="ra">Rec#</th><th class="la">Airport Name</th>
            </tr>
            DATA_ROWS
        </table>
    </section>
</main>
<footer>
    <address><p> </p></address>
</footer>
<script>

    function altHandler(event) {
        let alt = event.altKey
        document.body.className = alt ? 'alt-pressed' : ''
    }

    let div = document.querySelector('#map')
    div.addEventListener('mousemove', altHandler)
    window.addEventListener('keydown', altHandler)
    window.addEventListener('keyup', altHandler)

    let geo = null

    async function load() {
        let url = 'icao_lower-geo.json'
        try {
            geo = await (await fetch(url)).json()
        } catch (e) {
            console.log('error in loading GeoJSON data')
        }
        const ggUrl = 'https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}'
        const ggAttr = '&copy; <a href="https://www.google.com/permissions/geoguidelines/attr-guide/"'
            + ' target="_blank">Google</a> and contributors'
        const osUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
        const osAttr = '&copy; <a href="https://www.openstreetmap.org/copyright"'
            + ' target="_blank">OpenStreetMap</a> contributors'
        const mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw'
        const mbAttr = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>'
        const satellite = L.tileLayer(ggUrl, {maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: ggAttr})
        const streets = L.tileLayer(osUrl, {maxZoom: 20, attribution: osAttr})
        const faded = L.tileLayer(mbUrl, {maxZoom: 18, id: 'mapbox/light-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr})
        const baseLayers = {
            "Faded": faded,
            "Streets": streets,
            "Satellite": satellite,
        }
        const data_points = geo
        const pointLayer = L.geoJSON([], {
            pointToLayer: function (feature, latlng) {
                let label = String(feature.properties.name)
                return new L.CircleMarker(latlng, {
                    radius: 1,
                }).bindTooltip(label, {direction: 'auto', interactive: true, opacity: 0.7, permanent: false}).openTooltip()
            }
        })
        pointLayer.addData(data_points)
        const the_map = L.map('map', {
            center: [LAT_LON],
            zoom: ZOOM,
            layers: [faded, pointLayer]
        })
        const tooltips = new L.LayerGroup()
        tooltips.on('add', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content !== 'null') {
                    try {
                        marker.unbindTooltip()
                        tooltip.options.permanent = true
                        marker.bindTooltip(tooltip)
                    } catch (TypeError) {
                        // do nothing for now ...
                    }
                }
            })
        })
        tooltips.on('remove', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip) {
                    try {
                        marker.unbindTooltip()
                        tooltip.options.permanent = false
                        marker.bindTooltip(tooltip)
                    } catch (TypeError) {
                        // do nothing for now ...
                    }
                }
            })
        })
        const airports = new L.LayerGroup()
        airports.on('add', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes("class='apnd'")) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = true
                    marker.bindTooltip(tooltip)
                }
            })
        })
        airports.on('remove', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes("class='apnd'")) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = false
                    marker.bindTooltip(tooltip)
                }
            })
        })
        const runways = new L.LayerGroup()
        runways.on('add', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes('Runway')) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = true
                    marker.bindTooltip(tooltip)
                }
            })
        })
        runways.on('remove', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes('Runway')) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = false
                    marker.bindTooltip(tooltip)
                }
            })
        })
        const localizers = new L.LayerGroup()
        localizers.on('add', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes('Localizer')) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = true
                    marker.bindTooltip(tooltip)
                }
            })
        })
        localizers.on('remove', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes('Localizer')) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = false
                    marker.bindTooltip(tooltip)
                }
            })
        })
        const glideslopes = new L.LayerGroup()
        glideslopes.on('add', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes('Glideslope')) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = true
                    marker.bindTooltip(tooltip)
                }
            })
        })
        glideslopes.on('remove', function () {
            pointLayer.eachLayer(function (marker) {
                const tooltip = marker.getTooltip()
                if (tooltip && tooltip._content && tooltip._content.includes('Glideslope')) {
                    marker.unbindTooltip()
                    tooltip.options.permanent = false
                    marker.bindTooltip(tooltip)
                }
            })
        })
        const overlays = {
            "Airports<br>- - - Labels:": pointLayer,
//            "Labels": tooltips,
            "- APT": airports,
            "- RWY": runways,
            "- LOC": localizers,
            "- GLS": glideslopes,
        }

        L.control.layers(baseLayers, overlays).addTo(the_map);

        // enable Alt-Click to find coordinate at click position (hand cursor not so precise, but we can zoom)
        const popup = L.popup()
        function onMapClick(e) {
            if (e.originalEvent.altKey) {
                popup
                    .setLatLng(e.latlng)
                    .setContent("+" + e.latlng.toString())
                    .openOn(the_map)
            }
        }
        the_map.on('click', onMapClick)


    }

    load()

</script>
</body>
</html>
